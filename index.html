<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>新しいタブ</title></title>
    <style>
        body { margin: 0; overflow: hidden; background: #0a0a0a; font-family: 'Arial', sans-serif; }
        canvas { display: block; }
        #ui { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; color: white; }
        #score-container { position: absolute; top: 20px; left: 20px; }
        #score-val { font-size: 36px; font-weight: bold; color: #00ffcc; }
        #leaderboard {
            position: absolute; top: 20px; right: 20px;
            background: rgba(0, 0, 0, 0.7); padding: 15px; border-radius: 10px;
            border: 1px solid #444; min-width: 180px;
        }
        .rank-row { display: flex; justify-content: space-between; font-size: 14px; margin: 4px 0; }
        #lobby {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 15, 10, 0.95); display: flex; justify-content: center; align-items: center; z-index: 100; pointer-events: auto;
        }
        .lobby-content { text-align: center; color: #00ffcc; border: 2px solid #004d2c; padding: 50px; border-radius: 20px; background: #000; }
        input { padding: 12px; background: #111; border: 1px solid #00ffcc; color: #fff; width: 200px; text-align: center; margin-bottom: 20px; }
        button { padding: 12px 40px; background: #00ffcc; color: #000; border: none; cursor: pointer; font-weight: bold; border-radius: 50px; }
    </style>
</head>
<body>

<div id="lobby">
    <div class="lobby-content">
        <h1>SLITHERIN</h1>
        <input type="text" id="nickname" placeholder="NAME..." maxlength="10">
        <br>
        <button id="start-btn">JOIN GAME</button>
    </div>
</div>

<div id="ui">
    <div id="score-container">
        <div id="score-val">0</div>
        <div style="opacity: 0.6;">Space to BOOST</div>
    </div>
    <div id="leaderboard">
        <div style="color: #ffcc00; font-weight: bold; margin-bottom: 8px; border-bottom: 1px solid #555;">Leaderboard</div>
        <div id="rank-list"></div>
    </div>
</div>

<canvas id="gameCanvas"></canvas>

<script src="/socket.io/socket.io.js"></script>
<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const socket = io();

const WORLD_SIZE = 4000;
let width, height, player;
let otherSnakes = {};
let camera = { x: 0, y: 0 };
let mouse = { x: 0, y: 0, pressed: false };

class Snake {
    constructor(name, color, isPlayer = false) {
        this.name = name;
        this.color = color;
        this.isPlayer = isPlayer;
        this.init();
    }
    init() {
        this.x = 500 + Math.random() * (WORLD_SIZE - 1000);
        this.y = 500 + Math.random() * (WORLD_SIZE - 1000);
        this.segments = [];
        this.length = 25;
        this.radius = 12;
        this.angle = Math.random() * Math.PI * 2;
        this.speed = 3.5;
        this.dead = false;
        this.score = 0;
        this.invincible = 120;
        for (let i = 0; i < this.length; i++) this.segments.push({ x: this.x, y: this.y });
    }
    update() {
        if (this.dead) return;
        if (this.invincible > 0) this.invincible--;
        const canBoost = mouse.pressed && this.length > 15;
        this.speed = canBoost ? 7 : 3.5;
        if (canBoost) this.length -= 0.1;

        this.angle = Math.atan2(mouse.y - height / 2, mouse.x - width / 2);
        const newHead = {
            x: this.segments[0].x + Math.cos(this.angle) * this.speed,
            y: this.segments[0].y + Math.sin(this.angle) * this.speed
        };

        if (newHead.x < 0 || newHead.x > WORLD_SIZE || newHead.y < 0 || newHead.y > WORLD_SIZE) { this.dead = true; return; }

        this.segments.unshift(newHead);
        if (this.segments.length > this.length) this.segments.pop();
        this.score = Math.floor(this.length * 10);
        this.x = newHead.x; this.y = newHead.y;
    }
    draw(isMe = false) {
        ctx.save();
        if (this.invincible > 0) ctx.globalAlpha = 0.5;
        ctx.strokeStyle = isMe ? this.color : "#silver";
        ctx.lineWidth = this.radius * 2;
        ctx.lineCap = "round";
        ctx.beginPath();
        if(this.segments.length > 0) {
            ctx.moveTo(this.segments[0].x - camera.x, this.segments[0].y - camera.y);
            this.segments.forEach(seg => ctx.lineTo(seg.x - camera.x, seg.y - camera.y));
            ctx.stroke();
        }
        ctx.fillStyle = "white";
        ctx.fillText(this.name, this.segments[0].x - camera.x, this.segments[0].y - camera.y - 20);
        ctx.restore();
    }
}

function resize() {
    width = canvas.width = window.innerWidth;
    height = canvas.height = window.innerHeight;
}

document.getElementById('start-btn').onclick = () => {
    const nick = document.getElementById('nickname').value || "Snake";
    localStorage.setItem('slitherin-nick', nick);
    document.getElementById('lobby').style.display = 'none';
    player = new Snake(nick, "#00ffcc", true);
    socket.emit('join', { name: nick });
    loop();
};

socket.on('updatePlayers', data => { otherSnakes = data; });

function loop() {
    if (player.dead) { document.getElementById('lobby').style.display = 'flex'; return; }
    ctx.fillStyle = "#0a0a0a";
    ctx.fillRect(0, 0, width, height);

    player.update();
    camera.x = player.x - width / 2;
    camera.y = player.y - height / 2;

    // グリッド
    ctx.strokeStyle = "#1a1a1a";
    for (let x = -camera.x % 100; x < width; x += 100) { ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,height); ctx.stroke(); }
    for (let y = -camera.y % 100; y < height; y += 100) { ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(width,y); ctx.stroke(); }

    // 他のプレイヤー描画
    for (let id in otherSnakes) {
        if (id === socket.id) continue;
        const p = otherSnakes[id];
        ctx.strokeStyle = "silver";
        ctx.lineWidth = 24;
        ctx.beginPath();
        if(p.segments?.length > 0) {
            ctx.moveTo(p.segments[0].x - camera.x, p.segments[0].y - camera.y);
            p.segments.forEach(s => ctx.lineTo(s.x - camera.x, s.y - camera.y));
            ctx.stroke();
        }
    }

    player.draw(true);

    // ランキング表示（あなたの提示コード準拠）
    const all = [{name: player.name, score: player.score, isMe: true}, ...Object.values(otherSnakes).filter(s => s.id !== socket.id)];
    const list = all.sort((a,b) => b.score - a.score).slice(0, 7);
    document.getElementById('rank-list').innerHTML = list.map((s, i) => `
        <div class="rank-row" style="color: ${s.isMe ? '#00ffcc' : 'white'}">
            <span>#${i + 1} ${s.name}</span><span>${s.score || 0}</span>
        </div>`).join('');
    
    document.getElementById('score-val').innerText = player.score;
    socket.emit('move', { segments: player.segments, score: player.score });
    requestAnimationFrame(loop);
}

window.addEventListener('mousemove', e => { mouse.x = e.clientX; mouse.y = e.clientY; });
window.addEventListener('mousedown', () => mouse.pressed = true);
window.addEventListener('mouseup', () => mouse.pressed = false);
window.addEventListener('keydown', e => { if (e.code === "Space") mouse.pressed = true; });
window.addEventListener('keyup', e => { if (e.code === "Space") mouse.pressed = false; });
window.onresize = resize;
resize();
</script>
</body>
</html>
