<!DOCTYPE html>
<html>
<head>
    <title>Slitherin Online</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'serif'; }
        canvas { display: block; }
        #lobby {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 20, 10, 0.9); display: flex; justify-content: center; align-items: center; z-index: 100;
        }
        .content { text-align: center; color: #00ff88; border: 2px solid #004d2c; padding: 50px; border-radius: 20px; }
        input { padding: 10px; background: #111; border: 1px solid #004d2c; color: #fff; width: 200px; margin-bottom: 20px; }
        button { padding: 10px 30px; background: #004d2c; color: #fff; border: none; cursor: pointer; font-weight: bold; }
        #ui { position: fixed; top: 20px; left: 20px; color: #00ff88; font-size: 24px; pointer-events: none; }
    </style>
</head>
<body>
<div id="lobby">
    <div class="content">
        <h1>SLITHERIN</h1>
        <input type="text" id="nickname" placeholder="Name..." maxlength="12">
        <button id="start-btn">START</button>
    </div>
</div>
<div id="ui">Score: <span id="score-val">0</span></div>
<canvas id="game"></canvas>

<script src="https://cdn.socket.io"></script>
<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const socket = io(); // Render上では空でOK

let player = { id: null, name: "", x: 2500, y: 2500, segments: [], radius: 15, length: 25, score: 0, dead: false };
let others = {};
let particles = [];
let camera = { x: 0, y: 0 };
let mouse = { x: 0, y: 0, pressed: false };

function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
window.onresize = resize;
resize();

// ニックネーム復元
document.getElementById('nickname').value = localStorage.getItem('slitherin-nick') || "";

document.getElementById('start-btn').onclick = () => {
    player.name = document.getElementById('nickname').value || "Snake";
    localStorage.setItem('slitherin-nick', player.name);
    document.getElementById('lobby').style.display = 'none';
    socket.emit('join', { name: player.name });
    loop();
};

socket.on('playerMoved', data => { others[data.id] = data; });
socket.on('playerDisconnected', id => { delete others[id]; });

function loop() {
    ctx.fillStyle = "#000";
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    camera.x = player.x - canvas.width / 2;
    camera.y = player.y - canvas.height / 2;

    // 移動計算
    const angle = Math.atan2(mouse.y - canvas.height/2, mouse.x - canvas.width/2);
    const speed = mouse.pressed ? 7 : 4;
    player.x += Math.cos(angle) * speed;
    player.y += Math.sin(angle) * speed;

    player.segments.unshift({x: player.x, y: player.y});
    if (player.segments.length > player.length) player.segments.pop();

    // 自滅判定の修正 (頭と15節以降のみ判定 = 自分にはぶつからない)
    // 完全に自分をすり抜けたい場合はこのループを消す

    // ブーストエフェクト
    if (mouse.pressed) {
        particles.push({x: player.x, y: player.y, l: 1.0, c: "#00ff88"});
        player.score += 1;
        document.getElementById('score-val').innerText = player.score;
    }

    // 描画：他プレイヤー
    for (let id in others) {
        ctx.fillStyle = "#c0c0c0";
        others[id].segments.forEach(s => {
            ctx.beginPath(); ctx.arc(s.x - camera.x, s.y - camera.y, 15, 0, Math.PI*2); ctx.fill();
        });
    }

    // 描画：自分
    ctx.fillStyle = "#00ff88";
    player.segments.forEach(s => {
        ctx.beginPath(); ctx.arc(s.x - camera.x, s.y - camera.y, player.radius, 0, Math.PI*2); ctx.fill();
    });

    // パーティクル
    particles.forEach((p, i) => {
        p.l -= 0.02;
        ctx.globalAlpha = p.l;
        ctx.fillStyle = p.c;
        ctx.beginPath(); ctx.arc(p.x - camera.x, p.y - camera.y, 3, 0, Math.PI*2); ctx.fill();
        if (p.l <= 0) particles.splice(i, 1);
    });
    ctx.globalAlpha = 1;

    socket.emit('move', { x: player.x, y: player.y, segments: player.segments, score: player.score });
    requestAnimationFrame(loop);
}

window.addEventListener('mousemove', e => { mouse.x = e.clientX; mouse.y = e.clientY; });
window.addEventListener('mousedown', () => mouse.pressed = true);
window.addEventListener('mouseup', () => mouse.pressed = false);
</script>
</body>
</html>
